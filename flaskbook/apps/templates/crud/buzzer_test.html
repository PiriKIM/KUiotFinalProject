<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buzzer Control Test - 자세 분석 시스템</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .buzzer-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .control-btn {
            margin: 0.5rem;
            min-width: 120px;
        }
        .status-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 10px;
        }
        .status-connected { background-color: #28a745; }
        .status-disconnected { background-color: #dc3545; }
        .volume-slider {
            width: 100%;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center mb-4">
                    <i class="fas fa-volume-up"></i> ESP8266 Buzzer Control
                </h1>
            </div>
        </div>

        <!-- Connection Status -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-wifi"></i> 연결 상태</h5>
                    </div>
                    <div class="card-body">
                        <div id="connectionStatus">
                            <span class="status-indicator status-disconnected" id="statusIndicator"></span>
                            <span id="statusText">연결 확인 중...</span>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">ESP8266 IP: <span id="esp8266Ip">192.168.0.112</span></small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Buzzer Control -->
        <div class="row">
            <div class="col-md-6">
                <div class="buzzer-card">
                    <h3><i class="fas fa-music"></i> Buzzer Control</h3>
                    
                    <div class="mb-3">
                        <label class="form-label">볼륨 설정</label>
                        <div class="d-grid gap-2">
                            <button class="btn btn-success control-btn" onclick="setVolume(25)">
                                <i class="fas fa-volume-down"></i> 낮음 (25%)
                            </button>
                            <button class="btn btn-primary control-btn" onclick="setVolume(50)">
                                <i class="fas fa-volume-up"></i> 보통 (50%)
                            </button>
                            <button class="btn btn-danger control-btn" onclick="setVolume(75)">
                                <i class="fas fa-volume-mute"></i> 높음 (75%)
                            </button>
                        </div>
                        <div class="text-center mt-2">
                            <span id="volumeValue" class="badge bg-primary fs-6">보통</span>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button class="btn btn-light control-btn" onclick="testBuzzer()">
                            <i class="fas fa-play"></i> 테스트 비프
                        </button>
                        <button class="btn btn-warning control-btn" onclick="triggerBuzzer(1000)">
                            <i class="fas fa-bell"></i> 1초 알림
                        </button>
                        <button class="btn btn-danger control-btn" onclick="triggerBuzzer(2000)">
                            <i class="fas fa-exclamation-triangle"></i> 2초 경고
                        </button>
                        <button class="btn btn-info control-btn" onclick="setVolume()">
                            <i class="fas fa-cog"></i> 볼륨 설정
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-info-circle"></i> Buzzer 정보</h5>
                    </div>
                    <div class="card-body">
                        <div id="buzzerInfo">
                            <p>Buzzer 상태를 확인하는 중...</p>
                        </div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header">
                        <h5><i class="fas fa-history"></i> 로그</h5>
                    </div>
                    <div class="card-body">
                        <div id="logContainer" style="max-height: 200px; overflow-y: auto;">
                            <div class="text-muted">로그가 여기에 표시됩니다...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="row mt-4">
            <div class="col-12 text-center">
                <a href="/crud/" class="btn btn-primary">
                    <i class="fas fa-arrow-left"></i> 자세 분석으로 돌아가기
                </a>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 볼륨 설정 함수 (3단계)
        function setVolume(volume) {
            const volumeValue = document.getElementById('volumeValue');
            
            if (volume <= 33) {
                volumeValue.textContent = '낮음';
                volumeValue.className = 'badge bg-success fs-6';
            } else if (volume <= 66) {
                volumeValue.textContent = '보통';
                volumeValue.className = 'badge bg-primary fs-6';
            } else {
                volumeValue.textContent = '높음';
                volumeValue.className = 'badge bg-danger fs-6';
            }
            
            // 볼륨 설정 API 호출
            fetch('/api/buzzer/volume', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    volume: volume
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLog(`볼륨 설정: ${volumeValue.textContent} (${volume}%)`, 'success');
                } else {
                    addLog('볼륨 설정 실패', 'error');
                }
            })
            .catch(error => {
                addLog(`볼륨 설정 오류: ${error.message}`, 'error');
            });
        }

        // 로그 추가 함수
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `text-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'muted'}`;
            logEntry.innerHTML = `<small>[${timestamp}] ${message}</small>`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // 연결 상태 확인
        async function checkConnection() {
            try {
                const response = await fetch('/api/buzzer/status');
                const data = await response.json();
                
                const statusIndicator = document.getElementById('statusIndicator');
                const statusText = document.getElementById('statusText');
                const esp8266Ip = document.getElementById('esp8266Ip');
                
                if (data.connected) {
                    statusIndicator.className = 'status-indicator status-connected';
                    statusText.textContent = 'ESP8266 연결됨';
                    esp8266Ip.textContent = data.esp8266_ip;
                    addLog('ESP8266 연결 확인됨', 'success');
                } else {
                    statusIndicator.className = 'status-indicator status-disconnected';
                    statusText.textContent = 'ESP8266 연결되지 않음';
                    addLog('ESP8266 연결 실패', 'error');
                }
                
                // Buzzer 정보 업데이트
                updateBuzzerInfo(data);
                
            } catch (error) {
                addLog(`연결 확인 실패: ${error.message}`, 'error');
            }
        }

        // Buzzer 정보 업데이트
        function updateBuzzerInfo(data) {
            const buzzerInfo = document.getElementById('buzzerInfo');
            if (data.status) {
                buzzerInfo.innerHTML = `
                    <p><strong>상태:</strong> ${data.status.status || '알 수 없음'}</p>
                    <p><strong>볼륨:</strong> ${data.status.volume || '알 수 없음'}%</p>
                    <p><strong>IP 주소:</strong> ${data.esp8266_ip}</p>
                `;
            } else {
                buzzerInfo.innerHTML = '<p class="text-muted">Buzzer 정보를 가져올 수 없습니다.</p>';
            }
        }

        // Buzzer 테스트
        async function testBuzzer() {
            try {
                addLog('테스트 비프 전송 중...');
                const response = await fetch('/api/buzzer/test');
                const data = await response.json();
                
                if (data.success) {
                    addLog('테스트 비프 전송 성공', 'success');
                } else {
                    addLog('테스트 비프 전송 실패', 'error');
                }
            } catch (error) {
                addLog(`테스트 비프 오류: ${error.message}`, 'error');
            }
        }

        // Buzzer 트리거
        async function triggerBuzzer(duration) {
            try {
                // 현재 선택된 볼륨 값 가져오기
                const volumeValue = document.getElementById('volumeValue');
                let volume = 50; // 기본값
                
                if (volumeValue.textContent === '낮음') {
                    volume = 25;
                } else if (volumeValue.textContent === '보통') {
                    volume = 50;
                } else if (volumeValue.textContent === '높음') {
                    volume = 75;
                }
                
                addLog(`${duration}ms buzzer 트리거 (볼륨: ${volumeValue.textContent})`);
                
                const response = await fetch('/api/buzzer/trigger', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        duration: duration,
                        volume: volume
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    addLog(`Buzzer 트리거 성공 (${duration}ms)`, 'success');
                } else {
                    addLog('Buzzer 트리거 실패', 'error');
                }
            } catch (error) {
                addLog(`Buzzer 트리거 오류: ${error.message}`, 'error');
            }
        }



        // 페이지 로드 시 연결 상태 확인
        document.addEventListener('DOMContentLoaded', function() {
            checkConnection();
            addLog('Buzzer Control 페이지 로드됨');
            
            // 30초마다 연결 상태 확인
            setInterval(checkConnection, 30000);
        });
    </script>
</body>
</html> 